<html>
<head>

  <!-- load cartodb, jquery, d3js-->
  <script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script>
  <script src = "https://code.jquery.com/jquery-2.1.3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>

 <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" /> 

  <style>

   
    #map { 
        float: left;
        width: 800px; 
        height: 600px; 
        background: white; 
        border: solid black 1px;
	margin: 1px 1px 1px 1px;
    } 

    #layer_selector li {
        border-bottom: 1px solid #999;
        padding: 3px 3px;
        font-family: "Helvetica", Arial;
        font-size: 12px;
        color: #444;
        cursor: auto;
    }
 
    #layer_selector li:hover {
        background-color: #F0F0F0;
        cursor: pointer;
    }
 
    #layer_selector li.selected {
        background-color: #101010;
        color:white;
    }
    div.emapsite-infobox {
        padding: 5px;
        position: absolute;
        right: 10px;
        top: 60px;
	display: inline-block;
	-webkit-box-shadow: rgba(0, 0, 0, 0.5) 0 0 4px 2px;
	-moz-box-shadow: rgba(0, 0, 0, 0.5) 0 0 4px 2px;
	box-shadow: rgba(0, 0, 0, 0.5) 0 0 4px 2px;
	background: white;
	-webkit-border-radius: 1px;
	-moz-border-radius: 1px;
	-ms-border-radius: 1px;
	-o-border-radius: 1px;
	border-radius: 2px;
	border: 2px solid #999999;
	text-align:left;
	z-index:105;
     }

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

  </style>

  <script type = "text/javascript">

  var map;  
  var latlng;

    function init(){
      // initiate leaflet map
      map = new L.Map('map', { 
        center: [51.5, -0.12],
        zoom: 14,
        maxZoom: 20,
        minZoom: 5
      }).on('click', function(e){
         latlng = e.latlng; 
         getData(latlng);       
          
      });

      //add some tiles      
      //https://1.maps.nlp.nokia.com/maptile/2.1/maptile/newest/normal.day
      //https://cartodb-basemaps-d.global.ssl.fastly.net/dark_nolabels
      L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png', {
	maxZoom: 19,
	attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      //cartoDB visualization
      var layerUrl = 'https://bugblatter1.cartodb.com/api/v2/viz/bd3d6440-5a9c-11e5-ad0e-0e9d821ea90d/viz.json';

      cartodb.createLayer(map, layerUrl/*, {legends:false}*/)
        .addTo(map)
        .on('done', function(layers) {   

         //setup layer selector handler
         createLayerSelector(layers);

           //add search box
           var v = cdb.vis.Overlay.create('search', map.viz, {})
           v.show();
           $('#map').append(v.render().el);

           //add handler to get click position
           var sublayer0 = layers.getSubLayer(1);
           sublayer0.setInteraction(true);
           sublayer0.on('featureClick', function(e, latlng, pos, data) {              
              getData(new L.latLng(latlng[0], latlng[1]));
                
              }); // end click handler
           
          });// end create layer

       }//end init

    function getData(latlng){
         var qs = 'SELECT antisocial_2010, burglary_2010, antisocial_2011, burglary_2011, antisocial_2012, burglary_2012, antisocial_2013, ';
             qs += 'burglary_2013, antisocial_2014, burglary_2014, antisocial_2015, burglary_2015 FROM crimes WHERE ST_Intersects(the_geom, ST_SetSRID(ST_MakePoint(' + latlng.lng + ',' + latlng.lat + '), 4326))';     
         
         // can use $.getJSON or d3.json
         d3.json('https://bugblatter1.cartodb.com/api/v2/sql?type=JSON&api_key=a36647bedac6e46dbaed2c7d0eb72a5fbc0b162e&q=' + qs,         
             function(data) {                
                 charts('#chart', data.rows[0]);
             });
    }

  
    function charts(div_id, data){
        //move name out key
        var json = d3.entries(data);   
        
        //put in dims
        var dims = { top:10, left:50, bottom:20, right:10}; 
        dims.width = 300 - dims.left - dims.right;
        dims.height = 300 - dims.top - dims.bottom;
       
         var y = d3.scale.linear()
                .range([dims.height, 0])
                .domain([0, d3.max(json, function(d) { return d.value; })]);
         

         var x = d3.scale.ordinal()               
                .rangeRoundBands([0, dims.width], .2)
                .domain(json.map(function(d){ return d.key; }));

        var xAxis = d3.svg.axis()
                 .scale(x)
		 //alternate text labels
                 .tickFormat(function(d, i){ return (i % 2 == 0) ? '     ' + d.replace(/[a-z]+_/g,'') : '' ;})                       
                 .orient("bottom");

	var yAxis = d3.svg.axis()
	         .scale(y)
	         .orient("left");
	        // .tickFormat(d3.format(".2n"));
          
        
        //jquery to clear the div -- should be able to do with d3js, but chart keeps moving down.
        $(div_id).empty();
        //var svg = d3.selectAll(".bar").remove();         
        
        //create svg for histogram.
        var hsvg = d3.select(div_id)
            .append("svg")
            .attr("width", dims.width + dims.left + dims.right)
            .attr("height", dims.height + dims.top + dims.bottom)
            .append("g")
            .attr("transform", "translate(" + dims.left + "," + dims.top + ")");

        //create bar chart
        var bars = hsvg.selectAll("bar")
                .data(json)
                .enter()
                .append("g").attr("class", "bar");
        
     
        //create the rectangles.
        bars.append("rect")
            .attr("x", function(d) { return x(d.key); })
            .attr("y", function(d) { return y(d.value); })
            .attr("width", x.rangeBand())            
            .attr("height", function(d) { return dims.height - y(d.value); })
            .attr('fill', function(d) { return d.key.indexOf('burglary') > -1 ? '#0000ff' : '#ff0000'})
            .on("mouseover", function(d) {pie(d, '#pie');});
        
       hsvg.append("g")
            .attr("class", "x axis")
            .attr("font-size", "12px")
            .attr("transform", "translate(0," + dims.height + ")")             
            .call(xAxis);


	hsvg.append("g")
	      .attr("class", "y axis")
              .attr("font-size", "12px")
	      .call(yAxis)
	      .append("text")
	      .attr("transform", "rotate(-90)")
	      .attr("y", 6)
	      .attr("dy", ".71em")
	      .style("text-anchor", "end")
	      .text("Weighted crime");

	var alternate_ticks = true;

	var short_tick_length = 0;
	var long_tick_length = 4;

	// Alternate the tick line between long and short ticks
	d3.selectAll("g.x.axis g.tick line")
	    .attr("y2", function (d) {
		if (alternate_ticks) {
		    alternate_ticks = false;
		    return long_tick_length;
		} else {
		    alternate_ticks = true;
		    return short_tick_length;
		}
	    });

            
         /*                   
         json.forEach(function(d){
              console.log(x(d.key));
              console.log(x.rangeBand());
          });
          */        
      }

      function pie(data, div_id) {
           var year = data.key.replace(/[a-z]+_/g,'');
           var qs;

        
         //       qs +="     FROM (SELECT year, sum(count_type) as total, outcome FROM met_outcomes WHERE postcode = (SELECT postcode from crimes WHERE ST_Intersects(the_geom, ST_SetSRID(ST_MakePoint(" + latlng.lng + "," + latlng.lat + "), 4326))) AND year = " + year + " GROUP BY outcome, year) f";
           qs = "SELECT sum(count_type) as total, outcome FROM met_outcomes WHERE postcode = (SELECT postcode from crimes WHERE ST_Intersects(the_geom, ST_SetSRID(ST_MakePoint(" + latlng.lng + "," + latlng.lat + "), 4326))) AND year = " + year + " GROUP BY outcome, year";  
           console.log(qs);
           d3.json('https://bugblatter1.cartodb.com/api/v2/sql?type=JSON&api_key=a36647bedac6e46dbaed2c7d0eb72a5fbc0b162e&q=' + qs,
              function(data){
                  console.log(d3.entries(data.rows));
              }
           );

        $(div_id).empty();
      
        var dataset = [
          { label: 'Solved', count: 10 }, 
          { label: 'None', count: 20 },
          { label: 'Not solved', count: 30 }
        
        ];

        var width = 250;
        var height = 250;      
        var left = 50;
        var top = 20; 
        var radius = Math.min(width, height) / 2;

        var color = d3.scale.ordinal()
            .range(['#ff0000', '#00ff00', '#0000ff']); 

        var svg = d3.select(div_id)
          .append('svg')
          .attr('width', width + left)
          .attr('height', height + top)
          .append('g')
          .attr('transform', 'translate(' + ((width + left) / 2 ) + 
            ',' + ((height + top) / 2) + ')');

        var arc = d3.svg.arc()
          .outerRadius(radius);

        var pie = d3.layout.pie()
          .value(function(d) { return d.count; })
          .sort(null);

        var path = svg.selectAll('path')
          .data(pie(dataset))
          .enter()
          .append('path')
          .attr('d', arc)
          .attr('fill', function(d, i) { 
            return color(d.data.label);
          });

      }


    // handle layer selector
    var selectedLayer;
    function createLayerSelector(layers){
      //keep record of layers        
      var num_sublayers = layers.getSubLayerCount();
      //get a ref to layer selector
      var $options = $('#layer_selector li');
      
      //turn off all layers except first one.
      for (var i = 0; i < num_sublayers; i++){
         layers.getSubLayer(i).hide();
      }              
      layers.getSubLayer(0).show();

      $options.click(function(e) {     
         //turn off selected on all buttons   
         $options.removeClass('selected');
         var $li = $(e.target);    
         
         //highlight selected
         $li.addClass('selected');
         
         var layerNum = parseInt($li.attr('id')) ;
         
         if (selectedLayer != layerNum){             
             for (var i = 0; i < num_sublayers; i++){
                  layers.getSubLayer(i).hide();
             }              
             layers.getSubLayer(layerNum-1).show();                
          }          
      });
   }

</script>


</head>
<body onload = "init()">
 <div id="map">
  <div id="layer_selector" class="emapsite-infobox">
    <ul>        
     <li id="1" class="selected">Anti-social 2010</li>
     <li id="2">Vehicle 2010</li>
     <li id="3">Burglary 2010</li>     
    </ul>
  </div>
 
 </div>
<div id = "chart" style="top:5px"></div>
<div id = "pie"</div>
</body>
</html>
